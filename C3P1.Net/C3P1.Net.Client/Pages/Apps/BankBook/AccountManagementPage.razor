@page "/bankbook/accounts"
@using C3P1.Net.Shared.Data.Apps.BankBook
@using System.Globalization
@using C3P1.Net.Shared.Services.Apps.BankBook
@layout Layouts.BankBookLayout

@inject NavBreadcrumbService navBreadcrumb
@inject IBankAccountService bankAccount

@if (inMemoryData == null)
{
    <Paragraph><em>Loading...</em></Paragraph>
}
else if (inMemoryData.Count == 0)
{
    <Paragraph><em>No bank accounts found.</em></Paragraph>
}
else
{
    <Row>
        <Column>
            <Card>
                <CardHeader>
                    <CardTitle>Bank Accounts</CardTitle>
                </CardHeader>
                <CardBody>
                    <DataGrid TItem="BankAccount" Data="inMemoryData" Responsive ShowPageSizes @bind-SelectedRow="@selectedBankAccount" Hoverable>
                        <DataGridColumns>
                            <DataGridColumn TextAlignment="TextAlignment.Center" TItem="BankAccount" Field="@nameof(BankAccount.Code)" Caption="#" Width="60px" Sortable/>
                            <DataGridColumn TItem="BankAccount" Field="@nameof(BankAccount.Name)" Caption="Name" />
                            <DataGridColumn TItem="BankAccount" Field="@nameof(BankAccount.Bank)" Caption="Bank" />
                            <DataGridColumn TItem="BankAccount" Field="@nameof(BankAccount.Balance)" Caption="Balance" />
                        </DataGridColumns>
                    </DataGrid>
                </CardBody>
                <CardFooter>
                    @if (selectedBankAccount != null)
                    {
                        <CardText>
                            Selected Account: <strong>@selectedBankAccount.Name</strong> (Balance: @selectedBankAccount.Balance.ToString("C", new CultureInfo("fr-FR")))
                        </CardText>
                    }
                    else
                    {
                        <CardText>
                            No account selected.
                        </CardText>
                    }
                </CardFooter>
            </Card>
        </Column>
    </Row>
}

@code {
    [CascadingParameter]
    private Task<AuthenticationState> authenticationStateTask { get; set; } = null!;
    private BankAccount? selectedBankAccount = null;
    private List<BankAccount>? inMemoryData = null;

    protected override async Task OnInitializedAsync()
    {

        // NavState (breadcrumbs, etc) is Scoped, so it lives as long as our connection lives.
        // So when a new page is visited, we need to clear navigation to prevent breadcrumbs from bleed-over, etc.
        // This also makes the navbar invisible by default.
        navBreadcrumb.SetBreadcrumbs(new List<Node>()
        {
            new Node {Text = "BankBook", Link = "bankbook" },
            new Node {Text = "Accounts", Link = "bankbook/accounts" , Active = true}
        });

        // Load accounts from API or database here

        await LoadData();
        await base.OnInitializedAsync();
    }

    private async Task LoadData()
    {
        // get user id
        var user = (await authenticationStateTask).User;
        var currentUserId = Guid.Parse(user.Claims.Where(x => x.Type.EndsWith("nameidentifier")).First().Value);

        // load accounts from API or database
        inMemoryData = await bankAccount.GetBankAccountsAsync(currentUserId);
    }
}